{"version":3,"sources":["webpack:///webpack/bootstrap 8c62f8f23e350be8709c","webpack:///./src/index.js","webpack:///external \"botpress\"","webpack:///external \"botpress-version-manager\"","webpack:///./src/deamon.js","webpack:///external \"moment\"","webpack:///external \"bluebird\"","webpack:///external \"bluebird-retry\"","webpack:///external \"lodash\"","webpack:///./src/db.js"],"names":["db","knex","module","exports","init","bp","__dirname","get","then","_knex","ready","router","getRouter","req","res","next","listSchedules","broadcasts","rows","map","row","date_time","split","date","time","progress","total_count","sent_count","bool","parse","outboxed","type","content","text","errored","userTimezone","ts","id","filteringConditions","filters","JSON","send","put","body","timezone","addSchedule","post","updateSchedule","sendStatus","catch","err","status","message","delete","deleteSchedule","params","schedulingLock","sendingLock","INTERVAL_BASE","SCHEDULE_TO_OUTBOX_INTERVAL","SEND_BROADCAST_INTERVAL","emitChanged","throttle","events","emit","padDigits","number","digits","Array","Math","max","String","length","join","scheduleToOutbox","inFiveMinutes","add","toDate","endOfDay","upcomingFixedTime","isAfter","upcomingVariableTime","where","false","andWhere","whereNotNull","orWhere","whereNull","schedules","distinct","select","mapSeries","timezones","tz","initialTz","sign","Number","abs","relTime","schedule","adjustedTime","format","raw","scheduleId","count","update","true","logger","info","finally","_sendBroadcast","method","dropPromise","resolve","fnBody","filter","trim","test","fn","Function","userId","platform","some","values","v","warn","drop","debug","middlewares","sendOutgoing","to","sendBroadcasts","isPast","isBefore","now","limit","abort","max_tries","interval","backoff","scheduleUser","error","notifications","level","url","botpress","k","initialize","setInterval","Error","createTableIfNotExists","table","increments","primary","string","timestamp","boolean","integer","references","onDelete","dateTime","Date","created_on","stringify","insert","del"],"mappings":";;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,uBAAe;AACf;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;;;;;;;;;;;;;;;;;ACtCA;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;;;AAEA,KAAIA,KAAK,IAAT;AACA,KAAIC,OAAO,IAAX;;AAEAC,QAAOC,OAAP,GAAiB;AACfC,SAAM,cAASC,EAAT,EAAa;AACjB,2CAAaA,EAAb,EAAiBC,SAAjB;AACA,2BAAOD,EAAP;AACAA,QAAGL,EAAH,CAAMO,GAAN,GACCC,IADD,CACM,iBAAS;AACbP,cAAOQ,KAAP;AACAT,YAAK,kBAAGC,IAAH,CAAL;AACD,MAJD;AAKD,IATc;AAUfS,UAAO,eAASL,EAAT,EAAa;;AAElB,SAAMM,SAASN,GAAGO,SAAH,CAAa,oBAAb,CAAf;;AAEAD,YAAOJ,GAAP,CAAW,aAAX,EAA0B,UAACM,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC5Cf,UAAGgB,aAAH,GACCR,IADD,CACM,gBAAQ;AACZ,aAAMS,aAAaC,KAAKC,GAAL,CAAS,eAAO;AAAA,sCACZC,IAAIC,SAAJ,CAAcC,KAAd,CAAoB,GAApB,CADY;AAAA;AAAA,eAC1BC,IAD0B;AAAA,eACpBC,IADoB;;AAGjC,eAAMC,WAAWL,IAAIM,WAAJ,GACbN,IAAIO,UAAJ,GAAiBP,IAAIM,WADR,GAEb,+BAAQzB,IAAR,EAAc2B,IAAd,CAAmBC,KAAnB,CAAyBT,IAAIU,QAA7B,IAAyC,CAAzC,GAA6C,CAFjD;;AAIA,kBAAO;AACLC,mBAAMX,IAAIW,IADL;AAELC,sBAASZ,IAAIa,IAFR;AAGLH,uBAAU,+BAAQ7B,IAAR,EAAc2B,IAAd,CAAmBC,KAAnB,CAAyBT,IAAIU,QAA7B,CAHL;AAILI,sBAAS,+BAAQjC,IAAR,EAAc2B,IAAd,CAAmBC,KAAnB,CAAyBT,IAAIc,OAA7B,CAJJ;AAKLT,uBAAUA,QALL;AAMLU,2BAAc,CAACf,IAAIgB,EANd;AAOLb,mBAAMA,IAPD;AAQLC,mBAAMA,IARD;AASLa,iBAAIjB,IAAIiB,EATH;AAULC,kCAAqBlB,IAAImB,OAAJ,IAAeC,KAAKX,KAAL,CAAWT,IAAImB,OAAf;AAV/B,YAAP;AAYD,UAnBkB,CAAnB;;AAqBAzB,aAAI2B,IAAJ,CAASxB,UAAT;AACD,QAxBD;AAyBD,MA1BD;;AA4BAN,YAAO+B,GAAP,CAAW,aAAX,EAA0B,UAAC7B,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAAA,uBACaF,IAAI8B,IADjB;AAAA,WACpCpB,IADoC,aACpCA,IADoC;AAAA,WAC9BC,IAD8B,aAC9BA,IAD8B;AAAA,WACxBoB,QADwB,aACxBA,QADwB;AAAA,WACdZ,OADc,aACdA,OADc;AAAA,WACLD,IADK,aACLA,IADK;AAAA,WACCQ,OADD,aACCA,OADD;;AAE5CvC,UAAG6C,WAAH,CAAe,EAAEtB,UAAF,EAAQC,UAAR,EAAcoB,kBAAd,EAAwBZ,gBAAxB,EAAiCD,UAAjC,EAAuCQ,gBAAvC,EAAf,EACC/B,IADD,CACM;AAAA,gBAAMM,IAAI2B,IAAJ,CAAS,EAAEJ,IAAIA,EAAN,EAAT,CAAN;AAAA,QADN;AAED,MAJD;;AAMA1B,YAAOmC,IAAP,CAAY,aAAZ,EAA2B,UAACjC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAAA,wBACgBF,IAAI8B,IADpB;AAAA,WACrCN,EADqC,cACrCA,EADqC;AAAA,WACjCd,IADiC,cACjCA,IADiC;AAAA,WAC3BC,IAD2B,cAC3BA,IAD2B;AAAA,WACrBoB,QADqB,cACrBA,QADqB;AAAA,WACXZ,OADW,cACXA,OADW;AAAA,WACFD,IADE,cACFA,IADE;AAAA,WACIQ,OADJ,cACIA,OADJ;;AAE7CvC,UAAG+C,cAAH,CAAkB,EAAEV,MAAF,EAAMd,UAAN,EAAYC,UAAZ,EAAkBoB,kBAAlB,EAA4BZ,gBAA5B,EAAqCD,UAArC,EAA2CQ,gBAA3C,EAAlB,EACC/B,IADD,CACM;AAAA,gBAAMM,IAAIkC,UAAJ,CAAe,GAAf,CAAN;AAAA,QADN,EAECC,KAFD,CAEO,UAACC,GAAD,EAAS;AACdpC,aAAIqC,MAAJ,CAAW,GAAX,EAAgBV,IAAhB,CAAqB,EAAEW,SAASF,IAAIE,OAAf,EAArB;AACD,QAJD;AAKD,MAPD;;AASAzC,YAAO0C,MAAP,CAAc,iBAAd,EAAiC,UAACxC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AACnDf,UAAGsD,cAAH,CAAkBzC,IAAI0C,MAAJ,CAAWlB,EAA7B,EACC7B,IADD,CACM,YAAM;AACVM,aAAIkC,UAAJ,CAAe,GAAf;AACD,QAHD,EAICC,KAJD,CAIO,UAACC,GAAD,EAAS;AACdpC,aAAIqC,MAAJ,CAAW,GAAX,EAAgBV,IAAhB,CAAqB,EAAEW,SAASF,IAAIE,OAAf,EAArB;AACD,QAND;AAOD,MARD;AASD;AAlEc,EAAjB,C;;;;;;ACVA,sC;;;;;;ACAA,sD;;;;;;;;ACAA;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;;;AAEA,KAAInD,OAAO,IAAX;AACA,KAAII,KAAK,IAAT;;AAEA,KAAImD,iBAAiB,KAArB;AACA,KAAIC,cAAc,KAAlB;;AAEA,KAAMC,gBAAgB,KAAK,IAA3B;AACA,KAAMC,8BAA8BD,gBAAgB,CAApD;AACA,KAAME,0BAA0BF,gBAAgB,CAAhD;;AAEA,KAAMG,cAAc,iBAAEC,QAAF,CAAW,YAAM;AACnCzD,SAAMA,GAAG0D,MAAH,CAAUC,IAAV,CAAe,mBAAf,CAAN;AACD,EAFmB,EAEjB,IAFiB,CAApB;;AAIA,UAASC,SAAT,CAAmBC,MAAnB,EAA2BC,MAA3B,EAAmC;AACjC,UAAOC,MAAMC,KAAKC,GAAL,CAASH,SAASI,OAAOL,MAAP,EAAeM,MAAxB,GAAiC,CAA1C,EAA6C,CAA7C,CAAN,EAAuDC,IAAvD,CAA4D,CAA5D,IAAiEP,MAAxE;AACD;;AAED,UAASQ,gBAAT,GAA4B;AAC1B,OAAI,CAACzE,IAAD,IAASuD,cAAb,EAA6B;AAC3B;AACD;;AAED,OAAMmB,gBAAgB,wBAASC,GAAT,CAAa,CAAb,EAAgB,SAAhB,EAA2BC,MAA3B,EAAtB;AACA,OAAMC,WAAW,sBAAOH,aAAP,EAAsBC,GAAtB,CAA0B,EAA1B,EAA8B,OAA9B,EAAuCC,MAAvC,EAAjB;;AAEA,OAAME,oBAAoB,+BAAQ9E,IAAR,EAAcsB,IAAd,CAAmByD,OAAnB,CAA2BL,aAA3B,EAA0C,IAA1C,CAA1B;AACA,OAAMM,uBAAuB,+BAAQhF,IAAR,EAAcsB,IAAd,CAAmByD,OAAnB,CAA2BF,QAA3B,EAAqC,WAArC,CAA7B;;AAEAtB,oBAAiB,IAAjB;;AAEA,UAAOvD,KAAK,qBAAL,EACNiF,KADM,CACA;AACLpD,eAAU,+BAAQ7B,IAAR,EAAc2B,IAAd,CAAmBuD,KAAnB;AADL,IADA,EAINC,QAJM,CAIG,YAAW;AACnB,UAAKF,KAAL,CAAW,YAAW;AACpB,YAAKG,YAAL,CAAkB,IAAlB,EACCD,QADD,CACUL,iBADV;AAED,MAHD,EAICO,OAJD,CAIS,YAAW;AAClB,YAAKC,SAAL,CAAe,IAAf,EACCH,QADD,CACUH,oBADV;AAED,MAPD;AAQD,IAbM,EAcNzE,IAdM,CAcD,qBAAa;AACjB,YAAO,mBAAQW,GAAR,CAAYqE,SAAZ,EAAuB,oBAAY;;AAExC,cAAOvF,KAAK,OAAL,EACNwF,QADM,CACG,UADH,EAENC,MAFM,GAGNlF,IAHM,CAGD,qBAAa;AACjB,gBAAO,mBAAQmF,SAAR,CAAkBC,SAAlB,EAA6B,gBAAsB;AAAA,eAATC,EAAS,QAAnBjD,QAAmB;;AACxD,eAAMkD,YAAYD,EAAlB;AACA,eAAME,OAAOC,OAAOH,EAAP,KAAc,CAAd,GAAkB,GAAlB,GAAwB,GAArC;AACAA,gBAAK5B,UAAUI,KAAK4B,GAAL,CAASD,OAAOH,EAAP,CAAT,CAAV,EAAgC,CAAhC,CAAL;AACA,eAAMK,UAAU,2BAAUC,SAAS9E,SAAnB,GAA+B0E,IAA/B,GAAsCF,EAAtC,EAA4C,mBAA5C,EAAiEhB,MAAjE,EAAhB;AACA,eAAMuB,eAAe,+BAAQnG,IAAR,EAAcsB,IAAd,CAAmB8E,MAAnB,CAA0BF,SAAS/D,EAAT,GAAc+D,SAAS/D,EAAvB,GAA4B8D,OAAtD,CAArB;;AAEA,kBAAOjG,KAAKqG,GAAL,0OAMK,CAACH,SAAS9D,EAAV,EAAc+D,YAAd,EAA4BN,SAA5B,CANL,EAONtF,IAPM,EAAP;AAQD,UAfM,CAAP;AAgBD,QApBM,EAqBNA,IArBM,CAqBD,YAAM;AACV,gBAAOP,KAAK,kBAAL,EACNiF,KADM,CACA,EAAEqB,YAAYJ,SAAS9D,EAAvB,EADA,EAENqD,MAFM,CAECzF,KAAKqG,GAAL,CAAS,mBAAT,CAFD,EAGN9F,IAHM,GAGCD,GAHD,CAGK,CAHL,EAGQC,IAHR,CAGa,iBAAe;AAAA,eAAZgG,KAAY,SAAZA,KAAY;;AACjC,kBAAOvG,KAAK,qBAAL,EACNiF,KADM,CACA,EAAE7C,IAAI8D,SAAS9D,EAAf,EADA,EAENoE,MAFM,CAEC;AACN3E,uBAAU,+BAAQ7B,IAAR,EAAc2B,IAAd,CAAmB8E,IAAnB,EADJ;AAENhF,0BAAa8E;AAFP,YAFD,EAMNhG,IANM,CAMD,YAAM;AACVH,gBAAGsG,MAAH,CAAUC,IAAV,CAAe,sCACbT,SAAS9D,EADX,EACe,QAAQmE,KAAR,GAAgB,YAD/B;;AAGA,iBAAIL,SAAS5D,OAAT,IAAoBC,KAAKX,KAAL,CAAWsE,SAAS5D,OAApB,EAA6BiC,MAA7B,GAAsC,CAA9D,EAAiE;AAC/DnE,kBAAGsG,MAAH,CAAUC,IAAV,CAAe,6CACbT,SAAS9D,EADX,EACe,wCADf;AAED;;AAEDwB;AACD,YAhBM,CAAP;AAiBD,UArBM,CAAP;AAsBD,QA5CM,CAAP;AA6CD,MA/CM,CAAP;AAgDD,IA/DM,EAgENgD,OAhEM,CAgEE,YAAM;AACbrD,sBAAiB,KAAjB;AACD,IAlEM,CAAP;AAmED;;AAED,KAAMsD,iBAAiB,mBAAQC,MAAR,CAAe,eAAO;;AAE3C,OAAIC,cAAc,mBAAQC,OAAR,CAAgB,KAAhB,CAAlB;;AAEA,OAAI7F,IAAImB,OAAR,EAAiB;AACfyE,mBAAc,mBAAQrB,SAAR,CAAkBnD,KAAKX,KAAL,CAAWT,IAAImB,OAAf,CAAlB,EAA2C,kBAAU;AACjE,WAAI2E,SAASC,OAAOC,IAAP,EAAb;AACA,WAAI,CAAC,YAAYC,IAAZ,CAAiBH,MAAjB,CAAL,EAA+B;AAC7BA,kBAAS,YAAYA,MAArB;AACD;;AAED,WAAMI,KAAK,IAAIC,QAAJ,CAAa,IAAb,EAAmB,QAAnB,EAA6B,UAA7B,EAAyCL,MAAzC,CAAX;AACA,cAAO,mBAAQH,MAAR,CAAeO,EAAf,EAAmBjH,EAAnB,EAAuBe,IAAIoG,MAA3B,EAAmCpG,IAAIqG,QAAvC,CAAP;AACD,MARa,EASbjH,IATa,CASR,kBAAU;AACd,cAAO,iBAAEkH,IAAF,CAAOC,MAAP,EAAe,aAAK;AACzB,aAAIC,MAAM,IAAN,IAAcA,MAAM,KAAxB,EAA+B;AAC7BvH,cAAGsG,MAAH,CAAUkB,IAAV,CAAe,iDACb,4CADF;AAED;;AAED,gBAAO,OAAOD,CAAP,KAAc,WAAd,IAA6BA,MAAM,IAAnC,IAA2CA,MAAM,IAAxD;AACD,QAPM,CAAP;AAQD,MAlBa,CAAd;AAmBD;;AAED,UAAOZ,YAAYxG,IAAZ,CAAiB,gBAAQ;AAC9B,SAAIsH,IAAJ,EAAU;AACRzH,UAAGsG,MAAH,CAAUoB,KAAV,CAAgB,+BAA+B3G,IAAImF,UAAnC,GACZ,YADY,GACGnF,IAAIoG,MADP,GACgB,oBADhC;AAEA;AACD;;AAED,SAAIpG,IAAIW,IAAJ,KAAa,MAAjB,EAAyB;AACvB1B,UAAG2H,WAAH,CAAeC,YAAf,CAA4B;AAC1BR,mBAAUrG,IAAIqG,QADY;AAE1B1F,eAAM,MAFoB;AAG1BE,eAAMb,IAAIa,IAHgB;AAI1BqE,cAAK;AACH4B,eAAI9G,IAAIoG,MADL;AAEHpE,oBAAShC,IAAIa;AAFV;AAJqB,QAA5B;AASD,MAVD,MAUO;AACL,WAAMqF,KAAK,IAAIC,QAAJ,CAAa,IAAb,EAAmB,QAAnB,EAA6B,UAA7B,EAAyCnG,IAAIa,IAA7C,CAAX;AACA,cAAOqF,GAAGjH,EAAH,EAAOe,IAAIoG,MAAX,EAAmBpG,IAAIqG,QAAvB,CAAP;AACD;AACF,IArBM,CAAP;AAsBD,EAhDsB,CAAvB;;AAkDA,UAASU,cAAT,GAA0B;AACxB,OAAI,CAAClI,IAAD,IAASwD,WAAb,EAA0B;AACxB;AACD;;AAEDA,iBAAc,IAAd;;AAEA,OAAM2E,SAAS,+BAAQnI,IAAR,EAAcsB,IAAd,CAAmB8G,QAAnB,CAA4BpI,KAAKqG,GAAL,CAAS,yBAAT,CAA5B,EAAiE,+BAAQrG,IAAR,EAAcsB,IAAd,CAAmB+G,GAAnB,EAAjE,CAAf;;AAEArI,QAAK,kBAAL,EACCiF,KADD,CACOkD,MADP,EAEC3D,IAFD,CAEM,OAFN,EAEe,UAFf,EAE2B,yBAF3B,EAGCA,IAHD,CAGM,qBAHN,EAG6B,YAH7B,EAG2C,wBAH3C,EAIC8D,KAJD,CAIO,IAJP,EAKC7C,MALD,CAKQ,CACN,wBADM,EAEN,4BAFM,EAGN,kCAHM,EAIN,kCAJM,EAKN,sCALM,EAMN,wCANM,EAON,iCAPM,EAQN,yCARM,CALR,EAeClF,IAfD,CAeM,gBAAQ;AACZ,SAAIgI,QAAQ,KAAZ;AACA,YAAO,mBAAQ7C,SAAR,CAAkBzE,IAAlB,EAAwB,eAAO;AACpC,WAAIsH,KAAJ,EAAW;AAAE;AAAQ;AACrB,cAAO,6BAAM;AAAA,gBAAM1B,eAAe1F,GAAf,CAAN;AAAA,QAAN,EAAiC;AACtCqH,oBAAW,CAD2B;AAEtCC,mBAAU,IAF4B;AAGtCC,kBAAS;AAH6B,QAAjC,EAKNnI,IALM,CAKD,YAAM;AACV,gBAAOP,KAAK,kBAAL,EACNiF,KADM,CACA,EAAEsC,QAAQpG,IAAIwH,YAAd,EAA4BrC,YAAYnF,IAAImF,UAA5C,EADA,EAENlD,MAFM,GAGN7C,IAHM,CAGD,YAAM;AACVP,gBAAK,qBAAL,EACCiF,KADD,CACO,EAAE7C,IAAIjB,IAAImF,UAAV,EADP,EAECE,MAFD,CAEQ,EAAE9E,YAAY1B,KAAKqG,GAAL,CAAS,gBAAT,CAAd,EAFR,EAGC9F,IAHD,CAGM;AAAA,oBAAMqD,aAAN;AAAA,YAHN;AAID,UARM,CAAP;AASD,QAfM,EAgBNZ,KAhBM,CAgBA,eAAO;AACZuF,iBAAQ,IAAR;;AAEAnI,YAAGsG,MAAH,CAAUkC,KAAV,CAAgB,4BAA4BzH,IAAImF,UAAhC,GACd,sCADc,GAC2BrD,IAAIE,OAD/C;;AAGA/C,YAAGyI,aAAH,CAAiBrG,IAAjB,CAAsB;AACpBsG,kBAAO,OADa;AAEpB3F,oBAAS,gBAAgBhC,IAAImF,UAApB,GAAiC,UAAjC,GACP,wCAHkB;AAIpByC,gBAAK;AAJe,UAAtB;;AAOA,gBAAO/I,KAAK,qBAAL,EACNiF,KADM,CACA,EAAE7C,IAAIjB,IAAImF,UAAV,EADA,EAENE,MAFM,CAEC;AACNvE,oBAAS,+BAAQjC,IAAR,EAAc2B,IAAd,CAAmB8E,IAAnB;AADH,UAFD,EAKNlG,IALM,CAKD,YAAM;AACV,kBAAOP,KAAK,kBAAL,EACNiF,KADM,CACA,EAAEqB,YAAYnF,IAAImF,UAAlB,EADA,EAENlD,MAFM,GAGN7C,IAHM,CAGD;AAAA,oBAAMqD,aAAN;AAAA,YAHC,CAAP;AAID,UAVM,CAAP;AAWD,QAxCM,CAAP;AAyCD,MA3CM,CAAP;AA4CD,IA7DD,EA8DCgD,OA9DD,CA8DS,YAAM;AACbpD,mBAAc,KAAd;AACD,IAhED;AAiED;;AAEDvD,QAAOC,OAAP,GAAiB,UAAC8I,QAAD,EAAc;AAC7B5I,QAAK4I,QAAL;;AAEA5I,MAAGL,EAAH,CAAMO,GAAN,GACCC,IADD,CACM,aAAK;AAAA,eACc,kBAAG0I,CAAH,CADd;AAAA,SACDC,UADC,OACDA,UADC;;AAETlJ,YAAOiJ,CAAP;AACAC;AACD,IALD;;AAOAC,eAAY1E,gBAAZ,EAA8Bf,2BAA9B;AACAyF,eAAYjB,cAAZ,EAA4BvE,uBAA5B;AACD,EAZD,C;;;;;;AC3OA,oC;;;;;;ACAA,sC;;;;;;ACAA,4C;;;;;;ACAA,oC;;;;;;;;ACAA;;AAEA;;;;AACA;;;;;;AAEA,KAAI3D,OAAO,IAAX;;AAEA,UAASkJ,UAAT,GAAsB;AACpB,OAAI,CAAClJ,IAAL,EAAW;AACT,WAAM,IAAIoJ,KAAJ,CAAU,yCAAV,CAAN;AACD;;AAED,UAAO,+BAAQpJ,IAAR,EAAcqJ,sBAAd,CAAqC,qBAArC,EAA4D,UAAUC,KAAV,EAAiB;AAClFA,WAAMC,UAAN,CAAiB,IAAjB,EAAuBC,OAAvB;AACAF,WAAMG,MAAN,CAAa,WAAb;AACAH,WAAMI,SAAN,CAAgB,IAAhB;AACAJ,WAAMG,MAAN,CAAa,MAAb;AACAH,WAAMG,MAAN,CAAa,MAAb;AACAH,WAAMK,OAAN,CAAc,UAAd;AACAL,WAAMK,OAAN,CAAc,SAAd;AACAL,WAAMM,OAAN,CAAc,aAAd;AACAN,WAAMM,OAAN,CAAc,YAAd;AACAN,WAAMI,SAAN,CAAgB,YAAhB;AACAJ,WAAMG,MAAN,CAAa,SAAb;AACD,IAZM,EAaNlJ,IAbM,CAaD,YAAW;AACf,YAAO,+BAAQP,IAAR,EAAcqJ,sBAAd,CAAqC,kBAArC,EAAyD,UAAUC,KAAV,EAAiB;AAC/EA,aAAMM,OAAN,CAAc,YAAd,EAA4BC,UAA5B,CAAuC,wBAAvC,EAAiEC,QAAjE,CAA0E,SAA1E;AACAR,aAAMG,MAAN,CAAa,QAAb,EAAuBI,UAAvB,CAAkC,UAAlC;AACAP,aAAME,OAAN,CAAc,CAAC,YAAD,EAAe,QAAf,CAAd;AACAF,aAAMI,SAAN,CAAgB,IAAhB;AACD,MALM,CAAP;AAMD,IApBM,CAAP;AAqBD;;AAED,UAAS9G,WAAT,OAAuE;AAAA,OAAhDtB,IAAgD,QAAhDA,IAAgD;AAAA,OAA1CC,IAA0C,QAA1CA,IAA0C;AAAA,OAApCoB,QAAoC,QAApCA,QAAoC;AAAA,OAA1BZ,OAA0B,QAA1BA,OAA0B;AAAA,OAAjBD,IAAiB,QAAjBA,IAAiB;AAAA,OAAXQ,OAAW,QAAXA,OAAW;;AACrE,OAAIyH,WAAWzI,OAAO,GAAP,GAAaC,IAA5B;AACA,OAAIY,KAAK,IAAT;;AAEA,OAAIQ,QAAJ,EAAc;AACZR,UAAK,sBAAO,IAAI6H,IAAJ,CAASD,WAAW,GAAX,GAAiBpH,QAA1B,CAAP,EAA4CiC,MAA5C,EAAL;AACD;;AAED,OAAMzD,MAAM;AACVC,gBAAW2I,QADD;AAEV5H,SAAIA,KAAK,+BAAQnC,IAAR,EAAcsB,IAAd,CAAmB8E,MAAnB,CAA0BjE,EAA1B,CAAL,GAAqC,IAF/B;AAGVH,WAAMD,OAHI;AAIVD,WAAMA,IAJI;AAKVD,eAAU,KALA;AAMVI,cAAS,KANC;AAOVR,kBAAa,CAPH;AAQVC,iBAAY,CARF;AASVuI,iBAAY,+BAAQjK,IAAR,EAAcsB,IAAd,CAAmB+G,GAAnB,EATF;AAUV/F,cAASC,KAAK2H,SAAL,CAAe5H,OAAf;AAVC,IAAZ;;AAaA,UAAOtC,KAAK,qBAAL,EACNmK,MADM,CACChJ,GADD,EACM,IADN,EAENZ,IAFM,GAECD,GAFD,CAEK,CAFL,CAAP;AAGD;;AAED,UAASwC,cAAT,QAA8E;AAAA,OAApDV,EAAoD,SAApDA,EAAoD;AAAA,OAAhDd,IAAgD,SAAhDA,IAAgD;AAAA,OAA1CC,IAA0C,SAA1CA,IAA0C;AAAA,OAApCoB,QAAoC,SAApCA,QAAoC;AAAA,OAA1BZ,OAA0B,SAA1BA,OAA0B;AAAA,OAAjBD,IAAiB,SAAjBA,IAAiB;AAAA,OAAXQ,OAAW,SAAXA,OAAW;;AAC5E,OAAIyH,WAAWzI,OAAO,GAAP,GAAaC,IAA5B;AACA,OAAIY,KAAK,IAAT;AACA,OAAIQ,QAAJ,EAAc;AACZR,UAAK,sBAAO,IAAI6H,IAAJ,CAASD,WAAW,GAAX,GAAiBpH,QAA1B,CAAP,EAA4CiC,MAA5C,EAAL;AACD;;AAED,OAAMzD,MAAM;AACVC,gBAAW2I,QADD;AAEV5H,SAAI,+BAAQnC,IAAR,EAAcsB,IAAd,CAAmB8E,MAAnB,CAA0BjE,EAA1B,CAFM;AAGVH,WAAMD,OAHI;AAIVD,WAAMA,IAJI;AAKVQ,cAASC,KAAK2H,SAAL,CAAe5H,OAAf;AALC,IAAZ;;AAQA,UAAOtC,KAAK,qBAAL,EACNiF,KADM,CACA;AACL7C,SAAIA,EADC;AAELP,eAAU,+BAAQ7B,IAAR,EAAc2B,IAAd,CAAmBuD,KAAnB;AAFL,IADA,EAKNsB,MALM,CAKCrF,GALD,EAMNZ,IANM,EAAP;AAOD;;AAED,UAAS8C,cAAT,CAAwBjB,EAAxB,EAA4B;AAC1B,UAAOpC,KAAK,qBAAL,EACNiF,KADM,CACA,EAAE7C,IAAIA,EAAN,EADA,EAENgB,MAFM,GAGN7C,IAHM,CAGD,YAAM;AACV,YAAOP,KAAK,kBAAL,EACNiF,KADM,CACA,EAAEqB,YAAYlE,EAAd,EADA,EAENgI,GAFM,GAGN7J,IAHM,CAGD;AAAA,cAAM,IAAN;AAAA,MAHC,CAAP;AAID,IARM,CAAP;AASD;;AAED,UAASQ,aAAT,GAAyB;AACvB,UAAOf,KAAK,qBAAL,EAA4BO,IAA5B,EAAP;AACD;;AAEDN,QAAOC,OAAP,GAAiB,UAAC+I,CAAD,EAAO;AACtBjJ,UAAOiJ,CAAP;AACA,UAAO,EAAEC,sBAAF,EAActG,wBAAd,EAA2BS,8BAA3B,EAA2CP,8BAA3C,EAA2D/B,4BAA3D,EAAP;AACD,EAHD,C","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/Users/slvn/Desktop/botpress-broadcast\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 8c62f8f23e350be8709c","import { DatabaseHelpers as helpers } from 'botpress'\nimport checkVersion from 'botpress-version-manager'\n\nimport deamon from './deamon'\nimport DB from './db'\nimport moment from 'moment'\n\nlet db = null\nlet knex = null\n\nmodule.exports = {\n  init: function(bp) {\n    checkVersion(bp, __dirname)\n    deamon(bp)\n    bp.db.get()\n    .then(_knex => {\n      knex = _knex\n      db = DB(knex)\n    })\n  },\n  ready: function(bp) {\n\n    const router = bp.getRouter('botpress-broadcast')\n\n    router.get('/broadcasts', (req, res, next) => {\n      db.listSchedules()\n      .then(rows => {\n        const broadcasts = rows.map(row => {\n          const [date, time] = row.date_time.split(' ')\n          \n          const progress = row.total_count\n            ? row.sent_count / row.total_count\n            : helpers(knex).bool.parse(row.outboxed) ? 1 : 0\n\n          return {\n            type: row.type,\n            content: row.text,\n            outboxed: helpers(knex).bool.parse(row.outboxed),\n            errored: helpers(knex).bool.parse(row.errored),\n            progress: progress,\n            userTimezone: !row.ts,\n            date: date,\n            time: time,\n            id: row.id,\n            filteringConditions: row.filters && JSON.parse(row.filters)\n          }\n        })\n\n        res.send(broadcasts)\n      })\n    })\n\n    router.put('/broadcasts', (req, res, next) => {\n      const { date, time, timezone, content, type, filters } = req.body\n      db.addSchedule({ date, time, timezone, content, type, filters })\n      .then(id => res.send({ id: id }))\n    })\n\n    router.post('/broadcasts', (req, res, next) => {\n      const { id, date, time, timezone, content, type, filters } = req.body\n      db.updateSchedule({ id, date, time, timezone, content, type, filters })\n      .then(() => res.sendStatus(200))\n      .catch((err) => {\n        res.status(500).send({ message: err.message })\n      })\n    })\n\n    router.delete('/broadcasts/:id', (req, res, next) => {\n      db.deleteSchedule(req.params.id)\n      .then(() => {\n        res.sendStatus(200)\n      })\n      .catch((err) => {\n        res.status(500).send({ message: err.message })\n      })\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 3\n// module chunks = 0","import { DatabaseHelpers as helpers } from 'botpress'\n\nimport moment from 'moment'\nimport Promise from 'bluebird'\nimport retry from 'bluebird-retry'\nimport _ from 'lodash'\n\nimport DB from './db'\n\nlet knex = null\nlet bp = null\n\nlet schedulingLock = false\nlet sendingLock = false\n\nconst INTERVAL_BASE = 10 * 1000\nconst SCHEDULE_TO_OUTBOX_INTERVAL = INTERVAL_BASE * 1\nconst SEND_BROADCAST_INTERVAL = INTERVAL_BASE * 1\n\nconst emitChanged = _.throttle(() => {\n  bp && bp.events.emit('broadcast.changed')\n}, 1000)\n\nfunction padDigits(number, digits) {\n  return Array(Math.max(digits - String(number).length + 1, 0)).join(0) + number\n}\n\nfunction scheduleToOutbox() {\n  if (!knex || schedulingLock) {\n    return\n  }\n\n  const inFiveMinutes = moment().add(5, 'minutes').toDate()\n  const endOfDay = moment(inFiveMinutes).add(14, 'hours').toDate()\n\n  const upcomingFixedTime = helpers(knex).date.isAfter(inFiveMinutes, 'ts')\n  const upcomingVariableTime = helpers(knex).date.isAfter(endOfDay, 'date_time')\n\n  schedulingLock = true\n\n  return knex('broadcast_schedules')\n  .where({\n    outboxed: helpers(knex).bool.false()\n  })\n  .andWhere(function() {\n    this.where(function() {\n      this.whereNotNull('ts')\n      .andWhere(upcomingFixedTime)\n    })\n    .orWhere(function() {\n      this.whereNull('ts')\n      .andWhere(upcomingVariableTime)\n    })\n  })\n  .then(schedules => {\n    return Promise.map(schedules, schedule => {\n\n      return knex('users')\n      .distinct('timezone')\n      .select()\n      .then(timezones => {\n        return Promise.mapSeries(timezones, ({ timezone: tz }) => {\n          const initialTz = tz\n          const sign = Number(tz) >= 0 ? '+' : '-'\n          tz = padDigits(Math.abs(Number(tz)), 2)\n          const relTime = moment(`${schedule.date_time}${sign}${tz}`, 'YYYY-MM-DD HH:mmZ').toDate()\n          const adjustedTime = helpers(knex).date.format(schedule.ts ? schedule.ts : relTime)\n\n          return knex.raw(`insert into broadcast_outbox (\"userId\", \"scheduleId\", \"ts\")\n            select userId, ?, ?\n            from (\n              select id as userId \n              from users\n              where timezone = ?\n            ) as q1`, [schedule.id, adjustedTime, initialTz])\n          .then()\n        })\n      })\n      .then(() => {\n        return knex('broadcast_outbox')\n        .where({ scheduleId: schedule.id })\n        .select(knex.raw('count(*) as count'))\n        .then().get(0).then(({ count }) => {\n          return knex('broadcast_schedules')\n          .where({ id: schedule.id })\n          .update({\n            outboxed: helpers(knex).bool.true(),\n            total_count: count\n          })\n          .then(() => {\n            bp.logger.info('[broadcast] Scheduled broadcast #'\n            + schedule.id, '. [' + count + ' messages]')\n\n            if (schedule.filters && JSON.parse(schedule.filters).length > 0) {\n              bp.logger.info('[broadcast] Filters found on broadcast #' +\n                schedule.id, '. Filters are applied at sending time.')\n            }\n\n            emitChanged()\n          })\n        })\n      })\n    })\n  })\n  .finally(() => {\n    schedulingLock = false\n  })\n}\n\nconst _sendBroadcast = Promise.method(row => {\n  \n  var dropPromise = Promise.resolve(false)\n\n  if (row.filters) {\n    dropPromise = Promise.mapSeries(JSON.parse(row.filters), filter => {\n      let fnBody = filter.trim()\n      if (!/^return /i.test(fnBody)) {\n        fnBody = 'return ' + fnBody\n      }\n\n      const fn = new Function('bp', 'userId', 'platform', fnBody)\n      return Promise.method(fn)(bp, row.userId, row.platform)\n    })\n    .then(values => {\n      return _.some(values, v => {\n        if (v !== true && v !== false) {\n          bp.logger.warn('[broadcast] Filter returned something other ' +\n            'than a boolean (or a Promise of a boolean)')\n        }\n\n        return typeof(v) !== 'undefined' && v !== null && v !== true\n      })\n    })\n  }\n\n  return dropPromise.then(drop => {\n    if (drop) {\n      bp.logger.debug('[broadcast] Drop sending #' + row.scheduleId \n        + ' to user: ' + row.userId + '. Reason = Filters')\n      return\n    }\n\n    if (row.type === 'text') {\n      bp.middlewares.sendOutgoing({\n        platform: row.platform,\n        type: 'text',\n        text: row.text,\n        raw: {\n          to: row.userId,\n          message: row.text\n        }\n      })\n    } else {\n      const fn = new Function('bp', 'userId', 'platform', row.text)\n      return fn(bp, row.userId, row.platform)\n    }\n  })\n})\n\nfunction sendBroadcasts() {\n  if (!knex || sendingLock) {\n    return\n  }\n\n  sendingLock = true\n\n  const isPast = helpers(knex).date.isBefore(knex.raw('\"broadcast_outbox\".\"ts\"'), helpers(knex).date.now())\n\n  knex('broadcast_outbox')\n  .where(isPast)\n  .join('users', 'users.id', 'broadcast_outbox.userId')\n  .join('broadcast_schedules', 'scheduleId', 'broadcast_schedules.id')\n  .limit(1000)\n  .select([\n    'users.userId as userId',\n    'users.platform as platform',\n    'broadcast_schedules.text as text',\n    'broadcast_schedules.type as type',\n    'broadcast_schedules.id as scheduleId',\n    'broadcast_schedules.filters as filters',\n    'broadcast_outbox.ts as sendTime',\n    'broadcast_outbox.userId as scheduleUser'\n  ])\n  .then(rows => {\n    let abort = false\n    return Promise.mapSeries(rows, row => {\n      if (abort) { return }\n      return retry(() => _sendBroadcast(row), {\n        max_tries: 3,\n        interval: 1000,\n        backoff: 3\n      })\n      .then(() => {\n        return knex('broadcast_outbox')\n        .where({ userId: row.scheduleUser, scheduleId: row.scheduleId })\n        .delete()\n        .then(() => {\n          knex('broadcast_schedules')\n          .where({ id: row.scheduleId })\n          .update({ sent_count: knex.raw('sent_count + 1') })\n          .then(() => emitChanged())\n        })\n      })\n      .catch(err => {\n        abort = true\n\n        bp.logger.error('[broadcast] Broadcast #' + row.scheduleId +\n          ' failed. Broadcast aborted. Reason: ' + err.message)\n\n        bp.notifications.send({\n          level: 'error',\n          message: 'Broadcast #' + row.scheduleId + ' failed.'\n          + ' Please check logs for the reason why.',\n          url: '/logs'\n        })\n\n        return knex('broadcast_schedules')\n        .where({ id: row.scheduleId })\n        .update({\n          errored: helpers(knex).bool.true()\n        })\n        .then(() => {\n          return knex('broadcast_outbox')\n          .where({ scheduleId: row.scheduleId })\n          .delete()\n          .then(() => emitChanged())\n        })\n      })\n    })\n  })\n  .finally(() => {\n    sendingLock = false\n  })\n}\n\nmodule.exports = (botpress) => {\n  bp = botpress\n\n  bp.db.get()\n  .then(k => {\n    const { initialize } = DB(k)\n    knex = k\n    initialize()\n  })\n\n  setInterval(scheduleToOutbox, SCHEDULE_TO_OUTBOX_INTERVAL)\n  setInterval(sendBroadcasts, SEND_BROADCAST_INTERVAL)\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/deamon.js","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"bluebird-retry\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird-retry\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 8\n// module chunks = 0","import { DatabaseHelpers as helpers } from 'botpress'\n\nimport Promise from 'bluebird'\nimport moment from 'moment'\n\nvar knex = null\n\nfunction initialize() {\n  if (!knex) {\n    throw new Error('you must initialize the database before')\n  }\n\n  return helpers(knex).createTableIfNotExists('broadcast_schedules', function (table) {\n    table.increments('id').primary()\n    table.string('date_time')\n    table.timestamp('ts')\n    table.string('text')\n    table.string('type')\n    table.boolean('outboxed')\n    table.boolean('errored')\n    table.integer('total_count')\n    table.integer('sent_count')\n    table.timestamp('created_on')\n    table.string('filters')\n  })\n  .then(function() {\n    return helpers(knex).createTableIfNotExists('broadcast_outbox', function (table) {\n      table.integer('scheduleId').references('broadcast_schedules.id').onDelete('CASCADE')\n      table.string('userId').references('users.id')\n      table.primary(['scheduleId', 'userId'])\n      table.timestamp('ts')\n    })\n  })\n}\n\nfunction addSchedule({ date, time, timezone, content, type, filters }) {\n  let dateTime = date + ' ' + time\n  let ts = null\n\n  if (timezone) {\n    ts = moment(new Date(dateTime + ' ' + timezone)).toDate()\n  }\n\n  const row = {\n    date_time: dateTime,\n    ts: ts ? helpers(knex).date.format(ts) : null,\n    text: content,\n    type: type,\n    outboxed: false,\n    errored: false,\n    total_count: 0,\n    sent_count: 0,\n    created_on: helpers(knex).date.now(),\n    filters: JSON.stringify(filters)\n  }\n\n  return knex('broadcast_schedules')\n  .insert(row, 'id')\n  .then().get(0)\n}\n\nfunction updateSchedule({ id, date, time, timezone, content, type, filters }) {\n  let dateTime = date + ' ' + time\n  let ts = null\n  if (timezone) {\n    ts = moment(new Date(dateTime + ' ' + timezone)).toDate()\n  }\n\n  const row = {\n    date_time: dateTime,\n    ts: helpers(knex).date.format(ts),\n    text: content,\n    type: type,\n    filters: JSON.stringify(filters)\n  }\n\n  return knex('broadcast_schedules')\n  .where({\n    id: id,\n    outboxed: helpers(knex).bool.false()\n  })\n  .update(row)\n  .then()\n}\n\nfunction deleteSchedule(id) {\n  return knex('broadcast_schedules')\n  .where({ id: id })\n  .delete()\n  .then(() => {\n    return knex('broadcast_outbox')\n    .where({ scheduleId: id })\n    .del()\n    .then(() => true)\n  })\n}\n\nfunction listSchedules() {\n  return knex('broadcast_schedules').then()\n}\n\nmodule.exports = (k) => {\n  knex = k\n  return { initialize, addSchedule, deleteSchedule, updateSchedule, listSchedules }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js"],"sourceRoot":""}